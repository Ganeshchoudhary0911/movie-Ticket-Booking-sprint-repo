<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Select Seats</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
.seat {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.seat.btn-success {
    transform: scale(1.15);
    box-shadow: 0 0 10px rgba(0, 128, 0, 0.7);
}
.seat.btn-outline-success:hover {
    transform: scale(1.10);
}
</style>

</head>
<body class="bg-light">

<!-- TOP BAR -->
<div class="container-fluid bg-white border-bottom py-3">
<div class="container">
<h5 class="mb-1" th:text="${movieName}">Movie Name</h5>
<small class="text-muted">
  <span th:text="${theatreName}"></span> ·
  <span th:text="${showDate}"></span> ·
  <span th:text="${showTime}"></span>
</small>
</div>
</div>

<!-- SEATS -->
<div class="container my-4 text-center">

<div class="fw-bold mb-2">GOLD · ₹150</div>

<!-- ROW A -->
<div class="d-flex justify-content-center align-items-center gap-2 mb-3">
<div class="fw-bold me-2">A</div>
<button th:each="n : ${#numbers.sequence(1,10)}"
        class="btn seat"
        th:attr="data-seat-name=${'A' + n}, data-price=150"
        th:classappend="${bookedSeats.contains('A' + n)} ? ' btn-secondary disabled' : ' btn-outline-success'"
        th:text="${n}">
</button>
</div>

<!-- ROW B -->
<div class="d-flex justify-content-center align-items-center gap-2 mb-4">
<div class="fw-bold me-2">B</div>
<button th:each="n : ${#numbers.sequence(1,10)}"
        class="btn seat"
        th:attr="data-seat-name=${'B' + n}, data-price=150"
        th:classappend="${bookedSeats.contains('B' + n)} ? ' btn-secondary disabled' : ' btn-outline-success'"
        th:text="${n}">
</button>
</div>

<!-- ROW C -->
<div class="d-flex justify-content-center align-items-center gap-2 mb-3">
<div class="fw-bold me-2">C</div>
<button th:each="n : ${#numbers.sequence(1,10)}"
        class="btn seat"
        th:attr="data-seat-name=${'A' + n}, data-price=150"
        th:classappend="${bookedSeats.contains('A' + n)} ? ' btn-secondary disabled' : ' btn-outline-success'"
        th:text="${n}">
</button>
</div>

<!-- ROW D -->
<div class="d-flex justify-content-center align-items-center gap-2 mb-3">
<div class="fw-bold me-2">D</div>
<button th:each="n : ${#numbers.sequence(1,10)}"
        class="btn seat"
        th:attr="data-seat-name=${'A' + n}, data-price=150"
        th:classappend="${bookedSeats.contains('A' + n)} ? ' btn-secondary disabled' : ' btn-outline-success'"
        th:text="${n}">
</button>
</div>

<div class="fw-bold mb-2">SILVER · ₹100</div>

<!-- ROW E -->
<div class="d-flex justify-content-center align-items-center gap-2 mb-3">
<div class="fw-bold me-2">E</div>
<button th:each="n : ${#numbers.sequence(1,8)}"
        class="btn seat"
        th:attr="data-seat-name=${'A' + n}, data-price=100"
        th:classappend="${bookedSeats.contains('A' + n)} ? ' btn-secondary disabled' : ' btn-outline-success'"
        th:text="${n}">
</button>
</div>

<!-- ROW F -->
<div class="d-flex justify-content-center align-items-center gap-2 mb-3">
<div class="fw-bold me-2">F</div>
<button th:each="n : ${#numbers.sequence(1,8)}"
        class="btn seat"
        th:attr="data-seat-name=${'A' + n}, data-price=100"
        th:classappend="${bookedSeats.contains('A' + n)} ? ' btn-secondary disabled' : ' btn-outline-success'"
        th:text="${n}">
</button>
</div>

<!-- ROW G -->
<div class="d-flex justify-content-center align-items-center gap-2 mb-3">
<div class="fw-bold me-2">G</div>
<button th:each="n : ${#numbers.sequence(1,8)}"
        class="btn seat"
        th:attr="data-seat-name=${'A' + n}, data-price=100"
        th:classappend="${bookedSeats.contains('A' + n)} ? ' btn-secondary disabled' : ' btn-outline-success'"
        th:text="${n}">
</button>
</div>

<!-- ROW H -->
<div class="d-flex justify-content-center align-items-center gap-2 mb-3">
<div class="fw-bold me-2">H</div>
<button th:each="n : ${#numbers.sequence(1,8)}"
        class="btn seat"
        th:attr="data-seat-name=${'A' + n}, data-price=100"
        th:classappend="${bookedSeats.contains('A' + n)} ? ' btn-secondary disabled' : ' btn-outline-success'"
        th:text="${n}">
</button>
</div>

<!-- ROW I -->
<div class="d-flex justify-content-center align-items-center gap-2 mb-3">
<div class="fw-bold me-2">I</div>
<button th:each="n : ${#numbers.sequence(1,8)}"
        class="btn seat"
        th:attr="data-seat-name=${'A' + n}, data-price=100"
        th:classappend="${bookedSeats.contains('A' + n)} ? ' btn-secondary disabled' : ' btn-outline-success'"
        th:text="${n}">
</button>
</div>

<!-- ROW J -->
<div class="d-flex justify-content-center align-items-center gap-2 mb-3">
<div class="fw-bold me-2">J</div>
<button th:each="n : ${#numbers.sequence(1,8)}"
        class="btn seat"
        th:attr="data-seat-name=${'A' + n}, data-price=100"
        th:classappend="${bookedSeats.contains('A' + n)} ? ' btn-secondary disabled' : ' btn-outline-success'"
        th:text="${n}">
</button>
</div>

<div class="text-primary fw-bold mb-4">All eyes this way please!</div>
</div>

<!-- FORM -->
<form id="confirmForm"
      th:action="@{/confirm/{showId}(showId=${showId})}"
      method="post">

    <input type="hidden" name="amount" id="amountField">
    <input type="hidden" name="seatIds" id="seatIdsField">

    <input type="hidden"
           th:if="${_csrf != null}"
           th:name="${_csrf.parameterName}"
           th:value="${_csrf.token}" />
</form>

<!-- PAYMENT BAR -->
<div id="paymentBar" class="fixed-bottom bg-white border-top d-none">
  <div class="container d-flex justify-content-between align-items-center py-3">
    <div>
      <strong><span id="seatCount">0</span></strong> Seats |
      ₹<strong><span id="totalAmount">0</span></strong>
    </div>
    <button class="btn btn-danger px-4" onclick="goToPayment()">
      Pay ₹<span id="payAmount">0</span>
    </button>
  </div>
</div>

<script>
let selectedSeats = [];
let selectedPrices = [];

document.querySelectorAll('.seat').forEach(btn => {
  if (btn.classList.contains('disabled')) return;

  btn.addEventListener('click', () => {
    const seatName = btn.dataset.seatName;
    const price = parseInt(btn.dataset.price, 10);

    if (btn.classList.contains('btn-success')) {
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-success');
      selectedSeats = selectedSeats.filter(s => s !== seatName);
      const idx = selectedPrices.indexOf(price);
      if (idx > -1) selectedPrices.splice(idx, 1);
    } else {
      btn.classList.remove('btn-outline-success');
      btn.classList.add('btn-success');
      selectedSeats.push(seatName);
      selectedPrices.push(price);
    }
    updatePayment();
  });
});

function updatePayment() {
  const count = selectedSeats.length;
  const total = selectedPrices.reduce((a, b) => a + b, 0);
  document.getElementById("seatCount").innerText = count;
  document.getElementById("totalAmount").innerText = total;
  document.getElementById("payAmount").innerText = total;
  document.getElementById("paymentBar").classList.toggle("d-none", count === 0);
}

function goToPayment() {
  // 1) Validate
  if (selectedSeats.length === 0) {
    alert("Please select seats");
    return;
  }

  // 2) Fill hidden inputs
  const form = document.getElementById("confirmForm");
  if (!form) {
    console.error("Form #confirmForm not found");
    return;
  }

  document.getElementById("seatIdsField").value = selectedSeats.join(",");
  document.getElementById("amountField").value =
      selectedPrices.reduce((a, b) => a + b, 0);

  // 3) Force method=POST reliably
  form.setAttribute("method", "post");

  // 4) DEBUG: log details
  console.log("Submitting to:", form.getAttribute("action"));
  console.log("Method:", form.getAttribute("method"));
  console.log("Seats:", document.getElementById("seatIdsField").value);
  console.log("Amount:", document.getElementById("amountField").value);

  // 5) Submit
  form.submit();
}
</script>

</body>
</html>